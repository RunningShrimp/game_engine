name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配版本标签，如 v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build-release:
    name: Build Release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: game-engine-linux-x86_64
            extension: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: game-engine-windows-x86_64
            extension: zip
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: game-engine-macos-x86_64
            extension: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: game-engine-macos-aarch64
            extension: tar.gz
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          override: true
      
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-
      
      - name: Build release
        run: |
          cargo build --release --target ${{ matrix.target }}
      
      - name: Build documentation
        run: |
          cargo doc --no-deps --target ${{ matrix.target }} --release || echo "Documentation build failed, continuing..."
      
      - name: Prepare release artifacts
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ]; then
            VERSION=${{ github.event.inputs.version }}
          fi
          
          if [ -z "$VERSION" ]; then
            VERSION="dev"
          fi
          
          ARTIFACT_DIR="release-artifacts"
          mkdir -p "$ARTIFACT_DIR"
          
          # 复制二进制文件
          if [ "${{ runner.os }}" = "Windows" ]; then
            BINARY_NAME="game_engine.exe"
            BINARY_PATH="target/${{ matrix.target }}/release/$BINARY_NAME"
          else
            BINARY_NAME="game_engine"
            BINARY_PATH="target/${{ matrix.target }}/release/$BINARY_NAME"
          fi
          
          if [ -f "$BINARY_PATH" ]; then
            cp "$BINARY_PATH" "$ARTIFACT_DIR/"
          fi
          
          # 复制文档
          if [ -d "target/${{ matrix.target }}/doc" ]; then
            cp -r target/${{ matrix.target }}/doc "$ARTIFACT_DIR/docs" || true
          fi
          
          # 复制 README 和 LICENSE
          cp README.md "$ARTIFACT_DIR/" 2>/dev/null || true
          cp LICENSE "$ARTIFACT_DIR/" 2>/dev/null || true
          
          # 创建版本信息文件
          cat > "$ARTIFACT_DIR/VERSION" << EOF
          Version: $VERSION
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Target: ${{ matrix.target }}
          Commit: ${{ github.sha }}
          EOF
      
      - name: Create archive
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ]; then
            VERSION=${{ github.event.inputs.version }}
          fi
          
          if [ -z "$VERSION" ]; then
            VERSION="dev"
          fi
          
          ARCHIVE_NAME="${{ matrix.artifact_name }}-${VERSION}.${{ matrix.extension }}"
          
          if [ "${{ matrix.extension }}" = "tar.gz" ]; then
            tar -czf "$ARCHIVE_NAME" -C release-artifacts .
          else
            cd release-artifacts
            zip -r "../$ARCHIVE_NAME" .
            cd ..
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}-*.${{ matrix.extension }}
          retention-days: 90
  
  create-release:
    name: Create GitHub Release
    needs: build-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << EOF
          # Game Engine ${{ steps.version.outputs.version }}
          
          ## Release Information
          
          - **Version**: ${{ steps.version.outputs.version }}
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit**: ${{ github.sha }}
          
          ## Downloads
          
          Pre-built binaries are available for the following platforms:
          
          - Linux (x86_64)
          - Windows (x86_64)
          - macOS (x86_64)
          - macOS (Apple Silicon / ARM64)
          
          ## Installation
          
          Extract the archive for your platform and run the executable.
          
          ## Documentation
          
          Documentation is included in each release archive.
          
          ## Changes
          
          See the [CHANGELOG](CHANGELOG.md) for detailed changes.
          EOF
          
          cat release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*
          body_path: release_notes.md
          draft: false
          prerelease: false
          tag_name: ${{ github.ref }}
          name: Release ${{ steps.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  publish-docs:
    name: Publish Documentation
    needs: build-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rust-docs
      
      - name: Generate documentation
        run: |
          cargo doc --no-deps --all-features
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc
          destination_dir: ./docs

