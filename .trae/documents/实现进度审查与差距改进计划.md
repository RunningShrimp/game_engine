# 审查与改进总体计划

## 审查摘要
- 已实现：基础 2D 渲染与合批、ECS 组件、资源热重载（部分）、WASM 入口、egui 编辑器壳、Rapier2D。
- 未实现：3D/PBR/阴影/后处理、2D Flipbook/TileMap/光照、GPU 时间戳与 tracing、glTF 导入、OpenXR、音频（rodio/cpal）、Lua（mlua）、任务系统（rayon）、3D 物理与跨平台专用适配。
- 依赖问题：同一依赖重复条目（`bevy_ecs`、`tokio`、`rapier2d` 可选旧版），潜在冲突。

## 优先级（P0→P2）
- P0：2D 子系统完备（Sprite/Flipbook/TileMap/2D 光照）、GPU 计时与 tracing、性能基准、资源热重载打通。
- P1：3D 基线（PBR 材质、方向光+CSM 阴影、Bloom/ACES、glTF 导入）。
- P2：XR（OpenXR）、音频（rodio/cpal）、Lua（mlua）、任务系统（rayon）、Web 细化与跨平台适配。

## 分阶段实施步骤
### 阶段A：2D 完备与可观测性（3–4周）
1. 组件与渲染：实现 `render/2d` 管线（Sprite 批次→RenderGraph），加入 Flipbook 动画播放器与编辑器面板；TileSet/TileMap（规则铺设、分块渲染与裁剪）。
2. 2D 光照：法线贴图通道、点光简易阴影（soft-mask），合入 2D pass。
3. 可观测性：接入 `tracing`/`tracing-subscriber`，wgpu `QuerySet` 时间戳，帧时间分解 UI。
4. 基准：1K/10K 精灵场景与 TileMap 大图，指标展示。

### 阶段B：3D 基线（4–6周）
1. 材质系统：PBR（metallic/roughness/normal/AO/emissive/alpha）、IBL。
2. 阴影：方向光 CSM（级联可调、稳定级联、PCF）。
3. 后处理：Bloom、ACES Tone Mapping；基础 LUT。
4. glTF 导入：纹理/网格/材质/节点变换导入与资源管线对接。

### 阶段C：平台特性与扩展（4–6周）
1. XR：OpenXR 会话/空间/动作系统、双眼渲染与提交；90FPS 路线图。
2. 音频：`rodio` 播放/`cpal` 设备抽象，`AudioSource` 组件与资源管理。
3. 脚本：`mlua` 接入（Lua），完善 JS/Python 选择；统一绑定接口原型。
4. 并发：任务分区与 `rayon` 线程池，用于渲染前收集与可见性。
5. Web：WASM 构建优化、Canvas/DOM 叠层策略、资源缓存与虚拟 FS。

## 风险与资源
- 需要 3D/图形工程师（1–2）、工具/编辑器工程师（1）、平台与 XR 工程师（1）、系统与并发工程师（1）。
- 关键风险：PBR/CSM 着色器复杂度、跨平台后端差异、XR 时序与性能预算。

## 里程碑与KPI
- M1（4周）：2D 完备 + 可观测性，≥60FPS@1K 精灵，热重载 <200ms。
- M2（6周）：3D PBR/CSM/Bloom/ACES，≥60FPS@100K 三角。
- M3（6周）：XR/音频/脚本/并发，Web 性能与交互达标。

请确认以上计划，以便进入实施阶段（编辑依赖与新增模块），并按优先级推进修复与扩展。