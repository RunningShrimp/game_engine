## 阶段与目标
- 阶段1（快速修复与编译一致性）：修复特性分支与编译错误，确保基础模块在 macOS 桌面端稳定构建与运行。
- 阶段2（输入事件流水线）：落地 `winit -> InputEvent -> ECS/资源` 映射，建立可配置的输入绑定与示例。
- 阶段3（渲染职责统一）：合并 RenderGraph/LayerTree 与 RenderService 的职责，形成单一的“构建-合成-绘制”链路。
- 阶段4（WGPU特性与缓冲策略）：启用合理的设备特性与环形缓冲，降低上传与片元阶段开销。
- 阶段5（TileMap实例化）：以分块+GPU实例化替代逐格实体生成，控制 ECS 压力。
- 阶段6（音频系统统一）：将 `AudioSystem`（ECS接口）与 `AudioService`（rodio后端）统一为一致的可替换后端模型。
- 阶段7（3D物理接入）：把 3D 物理步进与同步纳入固定调度，提供示例与测试。
- 阶段8（基准与监控）：新增 criterion 基准与运行时统计导出，完善编辑器监控面板。

## 阶段1：快速修复与编译一致性
- 修复 `async_assets` 特性下事件推送的编译错误：`src/resources/async.rs:21-27` 的 `push_texture_ready(name, )` 缺失参数，改为匹配 `src/resources/events.rs` 的签名。
- 校验 `Cargo.toml:60-66` 特性矩阵（默认启用 `physics_2d`），确保桌面端构建通过；必要时为 WASM 条件编译分支添加空实现或特性门控。
- 增加单测：资源加载失败/成功事件、日志资源 `LogEvents` 更新路径（`src/core/mod.rs:344-371`）。
- 验收：`cargo build` 与现有单测/集成测全部通过；在示例工程运行无崩溃。

## 阶段2：输入事件流水线
- 在 `src/core/mod.rs:137-221` 的 `WindowEvent` 分支中，建立 `winit` → `platform::InputEvent` 映射，并将事件写入 ECS 资源或事件队列（使用 `bevy_ecs::Events` 或自研环形缓冲）。
- 依据 `src/platform/mod.rs:36-64` 的事件枚举，覆盖键盘/鼠标/触摸/手柄；引入 `src/config/input.rs` 的配置（敏感度/绑定）。
- 示例：增加简单交互（按键控制摄像机、鼠标拖拽 UI），展示事件到行为链路。
- 验收：交互示例中输入延迟 ≤ 1 帧；事件覆盖率与去抖动策略可配置。

## 阶段3：渲染职责统一
- 统一 LayerTree/RenderGraph（`src/render/graph.rs:201-227、238-265`）与 RenderService（`src/services/render.rs:148-205、220-254`）为单一命令管线：
  - 构建：从 ECS 世界生成统一的 `RenderObject`/Layer/Instances。
  - 合成：排序与分组（按 target/tex/layer），生成 `RenderCommand`。
  - 绘制：`WgpuRenderer.render(...)` 接收统一命令与实例/网格列表。
- 去除重复的数据结构与遍历函数，减少双轨维护；保留 UI 管线与 3D 管线接口的一致性。
- 验收：DrawCalls 与 Instances 统计稳定，功能回归无缺失；重复代码减少 ≥ 30%。

## 阶段4：WGPU特性与缓冲策略
- 设备特性：在 `src/render/wgpu.rs:145-148` 启用 `wgpu::Features`（如 `TIMESTAMP_QUERY`、必要的 `PUSH_CONSTANTS` 等），结合适配器能力选择 `present_mode`（`src/render/wgpu.rs:155-167`）。
- 环形缓冲：为 `instance_buffer/ui_instance_buffer/lights_buffer` 引入容量管理与重用策略，避免每帧重建与频繁 `queue.write_buffer`。
- 光照优化：将片元阶段的逐光累加（`src/render/wgpu.rs:231-240`）迁移为计算或分区缓存，减少片元循环；保留简约路径用于低端设备。
- 指标：2D 100k 实例，主通道 ≤ 10ms；UI ≤ 4ms；上传 ≤ 2ms；在 `RenderStats`（`src/core/mod.rs:321-335`）中可观测。

## 阶段5：TileMap实例化
- 默认关闭 `tilemap_build_system` 的逐格实体生成（`src/ecs/mod.rs:167-202`），改为将 TileMap 展开为实例缓冲条目，并结合 `tilemap_chunk_system`（`src/ecs/mod.rs:210-275`）的可视分块维护。
- 更新 LayerTree/RenderGraph 构建逻辑以支持 TileMap 实例数据批处理。
- 指标：视野内 40k 瓦片时 `DrawCalls ≤ 200`、`FrameTime ≤ 16.7ms`。

## 阶段6：音频系统统一
- 定义 `AudioBackend` trait（设备/解码/播放），以 rodio 实现为默认后端；`AudioSystem` 仅负责 ECS 状态与调用后端；整合 `src/services/audio.rs`。
- 统一 API：播放/停止/音量/循环/资源加载接口一致；示例与文档对齐。
- 验收：`tests/integration_test.rs:32-42` 更新为新 API 并通过；运行时音频状态与实际播放一致。

## 阶段7：3D物理接入
- 将 `physics_step_system_3d/sync_physics_to_transform_system_3d`（`src/physics/physics3d.rs:291-309`）纳入固定步 `Schedule`。
- 提供 3D 场景示例（刚体下落、射线/形状投射），验证与摄像机/渲染配合。
- 验收：3D 物理与渲染帧节奏误差率 ≤ 1%；相关单测通过（`src/physics/physics3d.rs:311-372`）。

## 阶段8：基准与监控
- 增加 criterion 基准：变换/蒙皮/粒子批处理、TileMap展开、命令图构建；已配置基准见 `Cargo.toml:72-78`。
- 运行时导出：将 `RenderStats/AssetMetrics` 导出 CSV 或在编辑器面板可视化；统计报警率（`alerts_main/ui/upload/offscreen`）。
- 验收：基准报告生成，编辑器面板展示核心指标；长时运行报警率 ≤ 1%。

## 风险与回滚
- WGPU特性兼容性：为低端/受限平台提供退化路径（特性门控）；保留现有稳定管线以便快速回滚。
- 渲染职责统一的 API 变更：提供过渡层与编译特性，确保示例与测试逐步迁移。
- 输入事件与音频统一的行为变化：以配置驱动、默认兼容旧路径。

## 交付与验收标准（量化）
- 编译与测试：全特性矩阵构建通过；单元/集成测试覆盖率提升（新增 ≥ 15 个用例）。
- 性能目标：1080p 桌面端，2D 100k 实例帧时 ≤ 16.7ms；TileMap 40k 瓦片 `DrawCalls ≤ 200`；上传 ≤ 2ms；UI ≤ 4ms。
- 稳定性：资源加载事件 P95 延迟 ≤ 120ms；长时运行报警率 ≤ 1%。

请确认以上实施计划。一旦确认，将开始分阶段修改代码、添加测试与基准，并在每阶段完成后提供验证结果与可视化统计。